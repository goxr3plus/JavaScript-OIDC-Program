<!DOCTYPE html>
<html>

<head>
    <title>JS Application</title>
    <meta charset="utf-8" />

    <!-- ------------------------- LINKS ------------------------------------ -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css" />

    <!--    Bootstrap Select-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">

    <!--    Bootstrap Tags-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput-typeahead.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" />

    <!-- ------------------------- SCRIPTS ------------------------------------ -->

    <!--Load JQuery-->
    <script src="node_modules/jquery/dist/jquery.js"></script>

    <!-- Load Bootstrap-->
    <script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>

    <!--Load oidc-client-->
    <script src="node_modules/oidc-client/dist/oidc-client.js"></script>

    <!-- Load Bootstrap-tagsinput -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>

    <!-- Drop Zone implementation -->
    <!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.js"></script>-->

    <style>
        input {
            font-weight: bold;
            background-color: black;
        }

        .main-container {
            padding-top: 70px;
        }

        pre:empty {
            display: none;
        }

        .container {
            margin-left: 20px;
            margin-right: 20px;
            width: auto;
            height: 100%;
        }

        .dropdown-toggle {
            border-radius: 0px !important;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: white;
        }

        .input-group-addon {
            min-width: 150px;
        }

    </style>
</head>

<body style="background-color:#303030; width:100%; height:100%;">

    <div class="container-fluid">
        <div class="row content">
            <div class="col-sm-12">

                <!-- Navigation Bar-->
                <nav class="navbar navbar-inverse navbar-fixed-top">
                    <div class="container">
                        <div class="navbar-header" style="margin-left: 33%;">

                            <a class="navbar-brand" href="#" style="color:white; ">OpenID Connect Javascript Application</a>


                        </div>
                    </div>
                </nav>

                <!-- Main Container -->
                <div id="invisible-div" class="container main-container" style="display:none">
                    <!-- style="display:none" -->

                    <!-- EXTRA URLS  -->
                    <div class="row">
                        <div class="container" style="padding-bottom: 3px">
                            <div class="input-group">
                                <span class="input-group-addon" style="color:black; font-weight:bold">Authority URL</span>
                                <input id="authority" type="text" value="http://localhost:8080/openid-connect-server-webapp" class="form-control">
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <div class="container" style="padding-bottom: 3px">
                            <div class="input-group">
                                <!-- Client ID -->
                                <span class="input-group-addon" style="color:black; font-weight:bold">Client ID</span>
                                <input id="client_id" type="text" value="client3" class="form-control">


                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="container" style="padding-bottom: 3px">
                            <div class="input-group">
                                <!-- Client Secret-->
                                <span class="input-group-addon" style="color:black; font-weight:bold">Client Secret</span>
                                <input id="client_secret" type="text" value="secret3" class="form-control">

                            </div>
                        </div>
                    </div>




                    <div class="row">
                        <div class="container" style="padding-bottom: 3px">
                            <div class="input-group">

                                <!-- URL OF API -->
                                <!-- <span class="input-group-addon" style="color:black; font-weight:bold">URL</span>
                                <input id="api-call-text-field1" type="text" value="http://localhost:8080/openid-connect-server-webapp" class="form-control">-->

                                <!-- HTTP REST API CALL-->
                                <span class="input-group-addon" style="color:black; font-weight:bold">API</span>
                                <select id="HTTP_METHOD" class="selectpicker" data-style="btn-success" data-width="auto">
                                   <option>GET</option>
                                   <option>POST</option>
                                   <option>DELETE</option>
                                   <option>PATCH</option>
                                   <option>PUT</option>
                                </select>

                                <!-- API CALL -->
                                <!--                                <span class="input-group-addon" style="color:black; font-weight:bold">API</span>-->
                                <select id="api-select-picker" class="selectpicker" data-style="btn-primary" data-width="auto">
                                    
                                  <optgroup label="Clients">
                                    <option>clients</option>
                                    <option>clients/{id}</option>
                                   </optgroup>

                                  <optgroup label="Whitelists">
                                   <option>whitelist</option>
                                   <option>whitelist/{id}</option>
                                  </optgroup>

                                  <optgroup label="Blacklists">
                                   <option>blacklist</option>
                                   <option>blacklist/{id}</option>
                                  </optgroup>
                        
                                <optgroup label="System Scopes">
                                 <option>scopes</option>
                                 <option>scopes/{id}</option>
                                 <option>scope/{id}</option>
                                </optgroup>

                                <optgroup label="User Site Approvals">
                                 <option>approved</option>
                                 <option>approved/{id}</option>
                                </optgroup>

                                <optgroup label="OAuth Tokens">
                                 <option>tokens/access</option>
                                 <option>tokens/access/{id}</option>
                                 <option>tokens/refresh</option>
                                <option>tokens/refresh/{id}</option>

                                <optgroup label="Data">
                                 <option>tokens/data</option>
                                </optgroup>
                               </select>

                                <input id="api-call-text-field" type="text" value="clients" class="form-control">
                            </div>
                        </div>
                    </div>





                    <!-- Response_type -->
                    <div class="row">
                        <div class="container" style="padding-bottom: 3px">
                            <div class="input-group">

                                <!-- Response type -->
                                <span class="input-group-addon" style="color:black; font-weight:bold">Response Type</span>

                                <!-- Select Picker -->
                                <select id="response_type" class="selectpicker" multiple data-actions-box="true" data-width="auto">
                              <option>code</option>
                              <option>id_token</option>
                              <option>token</option>
                            </select>

                            </div>
                        </div>
                    </div>

                    <!-- Scopes -->
                    <div class="row">
                        <div class="container" style="padding-bottom: 3px">

                            <div class="input-group">
                                <!-- Scopes -->
                                <span class="input-group-addon" style="color:black; font-weight:bold">Scopes</span>

                                <!-- Select Picker -->
                                <select id="scopes" class="selectpicker" multiple data-actions-box="true" data-width="auto">
                              <option>openid</option>
                              <option>profile</option>
                              <option>email</option>
                              <option>address</option>
                              <option>phone</option>
                              <option>offline_access</option>
                            </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="row" style="margin-left:40%; padding-top:60px">
                    <div class="col-sm-12">
                        <ul class="list-inline list-unstyled requests">
                            <!--                <li><a href="index.html" class="btn btn-primary">Home</a></li>-->
                            <li><button type="button" class="btn btn-success js-login">Login</button></li>
                            <li><button type="button" class="btn btn-warning js-call-api">Call API</button></li>
                            <li><button type="button" class="btn btn-danger js-logout">Logout</button></li>
                            <li> <span class="button-checkbox">
                                   <button type="button" class="btn" data-color="primary">Request Refresh Token</button>
                                   <input id="request_refresh_token" type="checkbox" class="hidden" />
                                 </span>
                            </li>
                        </ul>
                    </div>
                </div>


                <div class="row" style="margin-left:39%; padding-top: 30px;">
                    <div class="col-sm-12">
                        <h4 style="color:white"> Choose JSON Configuration File </h4>
                        <input type="file" id="file-input" accept=".json" style="cursor:pointer" />
                    </div>
                </div>

                <hr>

                <!-- END OF EXTRA URLS  -->

                <div class="container" style="padding-top: 15px">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">File Content</div>
                                <div class="panel-body">
                                    <pre id="file-content"></pre>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="panel panel-default">
                                    <div class="panel-heading">User data</div>
                                    <div class="panel-body">
                                        <pre class="js-user"></pre>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-3">
                                <div class="panel panel-default">
                                    <div class="panel-heading">API call result</div>
                                    <div class="panel-body">
                                        <pre class="js-api-result"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>






        <!-- ----------------------                       RUN THE MOTHERFUCKER SCRIPTS!!!!!!!!!!                 ------------------------------------ -->


        <!--  //Clear all the fields -->
        <script>
            $("#authority").val('');
            //$("#api-call-text-field").val('');

            $("#client_id").val('');
            $("#client_secret").val('');


            //Disable the Buttons by default show the user has to choose a File to Login 
            $('.js-login').prop("disabled", true);
            $('.js-call-api').prop("disabled", true);
            $('.js-logout').prop("disabled", true);
           
            //document.getElementById("invisible-div").style.display = "none";

        </script>

        <!--- File API------------------------------->

        <script>
            // Check for the various File API support.
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }

            function readSingleFile(e) {
                var file = e.target.files[0];
                if (!file) {
                    return;
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                    var contents = e.target.result;
                    displayContents(contents);
                };
                reader.readAsText(file);
            }

            //This method displays the contents of the file
            function displayContents(contents) {
                var element = document.getElementById('file-content');
                element.textContent = contents;
                var json = JSON.parse(contents);

                //console.log(json);


                //Clear all the fields
                $("#authority").val(json.authority);
                $("#client_id").val(json.client_id);
                $("#client_secret").val(json.client_secret);
                $("#response_type").selectpicker('val', json.response_type.split(" "));
                $("#scopes").selectpicker('val', json.scope.split(" "));

                updateManager();

                //Enable all the buttons and show the div
                $('.js-login').prop("disabled", false);
                $('.js-call-api').prop("disabled", false);
                $('.js-logout').prop("disabled", false);
               
                document.getElementById("invisible-div").style.display = "block";

            }

            document.getElementById('file-input')
                .addEventListener('change', readSingleFile, false);

        </script>


        <script>
            var settings, manager, user;

            //-----------------Refresh the Manager every time below text fields text is changing---------------------------
            $("#request_refresh_token").change(function() {
                if ($(this).is(':checked')) {
                    
                   // console.log$("#response_type").val();
                    
                  // $("#scopes").selectpicker('val', 'offline_access');
                } else {
                    
                  //  $("#scopes").selectpicker('val', 'offline_access');
                }
            });

            $("#api-call-text-field").on('keyup', function(e) {
                if (e.keyCode == 13) {
                    callApi();
                }
            });

            $('#authority').on('input', function() {
                updateManager();
            });

            $('#client_secret').on('input', function() {
                updateManager();
            });

            $('#client_id').on('input', function() {
                updateManager();
            });

            $('#api-select-picker').on('changed.bs.select', function(e) {

                //Value to be set
                var value = $(this).val().toString();

                //Set the text and focus the text field
                $("#api-call-text-field").val(value);
                $("#api-call-text-field").focus();


                //Select a range of text
                if (value.indexOf("{id}") >= 0)
                    document.getElementById("api-call-text-field").setSelectionRange(value.length - 4, value.length);

            });

            $('#HTTP_METHOD').on('changed.bs.select', function(e) {

                //Value to be set
                var value = $(this).val().toString();

                console.log(value);

                //Select a range of text     THIS bitch is bugged...
                //                if (value.indexOf("DELETE") >= 0) {
                //                    $(this).selectpicker('setStyle', 'btn-warning');
                //                    console.log("Entered on the DELETE IF");
                //                } else {
                //                    $(this).selectpicker('setStyle', 'btn-info');
                //                    console.log("Entered on the SUCCESS IF");
                //                }


            });



            //------------------------------------

            $('.js-login').on('click', function() {
                console.log("Loggin Button pressed");
                manager.signinPopup().catch(function(error) {
                    console.error('error while logging in through the popup', error);
                });
            });


            $('.js-call-api').on('click', function() {
                callApi();
            });


            $('.js-logout').on('click', function() {
                manager.signoutRedirect().catch(function(error) {
                    console.error('error while signing out user', error);
                });
            });




            //================== METHODS==================================

            function callApi() {
                var headers = {};
                if (user && user.access_token) {
                    headers['Authorization'] = 'Bearer ' + user.access_token;
                }

                $.ajax({
                    url: $("#authority").val() + "/api/" + $("#api-call-text-field").val(),
                    method: $("#HTTP_METHOD").val(),
                    dataType: 'json',
                    crossDomain: true,
                    headers: headers
                }).then(function(data) {
                    display('.js-api-result', data);
                }).catch(function(error) {
                    display('.js-api-result', {
                        status: error.status,
                        statusText: error.statusText,
                        response: error.responseJSON
                    });
                });
            }



            function updateManager() {

                settings = {
                    // authority: 'http://snf-761523.vm.okeanos.grnet.gr:8080/openid-connect-server-webapp',
                    authority: $("#authority").val(),
                    client_id: $("#client_id").val(),
                    client_secret: $("#client_secret").val(),
                    user_id: "user",
                    popup_redirect_uri: 'http://localhost/jsApp/popup.html',
                    silent_redirect_uri: 'http://localhost/jsApp/silent-renew.html',
                    post_logout_redirect_uri: 'http://localhost/jsApp/index.html',

                    response_type: $("#response_type").val().toString().replace(/,/g, ' '),
                    scope: $("#scopes").val().toString().replace(/,/g, ' '),

                    filterProtocolClaims: false
                };

                manager = new Oidc.UserManager(settings);

                Oidc.Log.logger = console;

                manager.events.addUserLoaded(function(loadedUser) {
                    user = loadedUser;
                    display('.js-user', user);
                });

                manager.events.addSilentRenewError(function(error) {
                    console.error('error while renewing the access token', error);
                });

                manager.events.addUserSignedOut(function() {
                    alert('The user has signed out');
                });

            }

            // helper function to show data to the user
            function display(selector, data) {
                if (data && typeof data === 'string') {
                    data = JSON.parse(data);
                }
                if (data) {
                    data = JSON.stringify(data, null, 2);
                }

                $(selector).text(data);
            }

            updateManager();


            //Some extra fancy code here
            //var currentdate = new Date();
            //            var datetime = "js-call-api button cliked at: " + currentdate.getDate() + "/" +
            //                (currentdate.getMonth() + 1) + "/" +
            //                currentdate.getFullYear() + " @ " +
            //                currentdate.getHours() + ":" +
            //                currentdate.getMinutes() + ":" +
            //                currentdate.getSeconds();
            //            var datetime = $("#response_type").val().toString().replace(/,/g, ' ');
            //
            //            //Set the value to the extra div
            //            $('#extraDiv').fadeOut(150, function() {
            //                $(this).append($("#extraDiv").val() + "<br>" + datetime).fadeIn(150);
            //            });

            $(function() {
                $('.button-checkbox').each(function() {

                    // Settings
                    var $widget = $(this),
                        $button = $widget.find('button'),
                        $checkbox = $widget.find('input:checkbox'),
                        color = $button.data('color'),
                        settings = {
                            on: {
                                icon: 'glyphicon glyphicon-check'
                            },
                            off: {
                                icon: 'glyphicon glyphicon-unchecked'
                            }
                        };

                    // Event Handlers
                    $button.on('click', function() {
                        $checkbox.prop('checked', !$checkbox.is(':checked'));
                        $checkbox.triggerHandler('change');
                        updateDisplay();
                    });
                    $checkbox.on('change', function() {
                        updateDisplay();
                    });

                    // Actions
                    function updateDisplay() {
                        var isChecked = $checkbox.is(':checked');

                        // Set the button's state
                        $button.data('state', (isChecked) ? "on" : "off");

                        // Set the button's icon
                        $button.find('.state-icon')
                            .removeClass()
                            .addClass('state-icon ' + settings[$button.data('state')].icon);

                        // Update the button's color
                        if (isChecked) {
                            $button
                                .removeClass('btn-default')
                                .addClass('btn-' + color + ' active');
                        } else {
                            $button
                                .removeClass('btn-' + color + ' active')
                                .addClass('btn-default');
                        }
                    }

                    // Initialization
                    function init() {

                        updateDisplay();

                        // Inject the icon if applicable
                        if ($button.find('.state-icon').length == 0) {
                            $button.prepend('<i class="state-icon ' + settings[$button.data('state')].icon + '"></i> ');
                        }
                    }
                    init();
                });
            });

        </script>

</body>

</html>
